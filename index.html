<!DOCTYPE html>
<html lang="zh-Hant-TW">

<head>
    <meta charset="utf-8" />
    <title>Leaflet.SimpleLocate - Demo (Altitude Eklendi)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <script src="dist/leaflet-simple-locate.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/low-pass-filter@1.0.0/dist/low-pass-filter.min.js"></script>

    <link rel="stylesheet" href="examples/demo.css" />
    <link rel="stylesheet" href="examples/style.css" />

    <style>
        .leaflet-control-wei-ye-info {
            background: white;
            padding: 10px 12px;
            font-family: Arial, sans-serif;
            font-size: 14px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
            border-radius: 4px;
            min-width: 170px;
        }

        .accuracy-value.accuracy-good {
            color: #4CAF50;
        }

        .accuracy-value.accuracy-medium {
            color: #FFC107;
        }

        .accuracy-value.accuracy-low {
            color: #FF9800;
        }

        .accuracy-value.accuracy-poor {
            color: #F44336;
        }
    </style>
</head>

<body>
    <div id="map" style="width: 100vw; height: 100vh;"></div>

    <script>
        "use strict";

        // Harita başlatma
        const map = new L.Map("map", {
            center: [37.425930, 31.852214],
            zoom: 18,
            zoomControl: false,
        });

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // Wei Ye bilgi paneli
        function createWeiYeInfoControl() {
            const WeiYeInfoControl = L.Control.extend({
                options: { position: 'topright' },

                onAdd: function (map) {
                    this._container = L.DomUtil.create('div', 'leaflet-control-wei-ye-info');
                    this._container.innerHTML = `
                        <div class="wei-ye-info-panel">
                            <div class="wei-ye-title">
                                Konum Bilgisi
                                <small style="opacity: 0.7; font-weight: normal; font-size: 90%;">Filtrelenmiş</small>
                            </div>
                            <div class="wei-ye-stats">
                                <div>Doğruluk: <span class="accuracy-value">--</span> m</div>
                                <div>Altitude: <span class="altitude-value">--</span> m</div>
                                <div>Durum: <span class="is-filtered">Bekleniyor</span></div>
                            </div>
                        </div>
                    `;
                    return this._container;
                },

                updateStats: function (stats) {
                    const accuracyEl = this._container.querySelector('.accuracy-value');
                    const filteredEl = this._container.querySelector('.is-filtered');
                    const altitudeEl = this._container.querySelector('.altitude-value');

                    if (!accuracyEl || !filteredEl || !altitudeEl) return;

                    accuracyEl.textContent = Math.round(stats.accuracy);
                    altitudeEl.textContent = stats.altitude !== undefined && stats.altitude !== null
                        ? stats.altitude.toFixed(1)
                        : '--';

                    if (stats.accuracy <= 5) {
                        accuracyEl.className = 'accuracy-value accuracy-good';
                    } else if (stats.accuracy <= 15) {
                        accuracyEl.className = 'accuracy-value accuracy-medium';
                    } else if (stats.accuracy <= 30) {
                        accuracyEl.className = 'accuracy-value accuracy-low';
                    } else {
                        accuracyEl.className = 'accuracy-value accuracy-poor';
                    }

                    if (stats.accuracy > 50) {
                        this._container.style.border = '2px solid #F44336';
                        filteredEl.textContent = "Belirsiz Konum";
                        filteredEl.style.color = '#F44336';
                    } else {
                        this._container.style.border = '';
                        if (stats.isJump) {
                            filteredEl.textContent = "Sıçrama düzeltildi";
                            filteredEl.style.color = '#FF9800';

                            setTimeout(() => {
                                filteredEl.textContent = "Normal";
                                filteredEl.style.color = '#4CAF50';
                            }, 2000);
                        } else if (!stats.initializing) {
                            filteredEl.textContent = "Normal";
                            filteredEl.style.color = '#4CAF50';
                        }
                    }
                }
            });

            return new WeiYeInfoControl().addTo(map);
        }

        // Wei Ye kontrol panelini oluştur
        const weiYeInfoControl = createWeiYeInfoControl();

        // SimpleLocate kontrolü
        const control = new L.Control.SimpleLocate({
            position: "topleft",

            medianWindowSize: 7,
            kalmanProcessNoise: 0.01,
            kalmanMeasurementNoise: 0.1,
            jumpThreshold: 0.0001,
            showFilterInfo: false,
            enableFiltering: true,
            showFilterDebug: false,
            showJumpWarnings: true,
            lowPassFilterTau: 1.0,
            enableLowPassFilter: true,

            afterDeviceMove: (location) => {
                // Önce SimpleLocate konum verilerini kullan
                const lat = location.lat;
                const lng = location.lng;
                const accuracy = location.accuracy;

                // navigator.geolocation'dan altitude almak için çağrı
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        const altitude = pos.coords.altitude !== null ? pos.coords.altitude : NaN;

                        // Paneli altitude ile güncelle
                        weiYeInfoControl.updateStats({
                            accuracy: accuracy,
                            altitude: altitude,
                            isJump: location.isJump,
                            initializing: control._weiYeState?.filteringStats.totalUpdates < 3
                        });
                    },
                    (err) => {
                        // Hata durumunda altitude NaN olarak güncelle
                        weiYeInfoControl.updateStats({
                            accuracy: accuracy,
                            altitude: NaN,
                            isJump: location.isJump,
                            initializing: control._weiYeState?.filteringStats.totalUpdates < 3
                        });
                    }
                );
            },

            afterClick: (status) => {
                console.log("Geolocation status:", status.geolocation);
                console.log("Orientation status:", status.orientation);
                if (!status.geolocation) {
                    L.popup()
                        .setLatLng(map.getCenter())
                        .setContent('<span style="color: red; font-weight:bold;">Konum alınamadı</span>')
                        .openOn(map);
                }
            }
        }).addTo(map);

    </script>
    <script src="dist/line-tracking.js"></script>
</body>

</html>