<!DOCTYPE html>
<html lang="zh-Hant-TW">
  <head>
    <meta charset="utf-8" />
    <title>Leaflet.SimpleLocate - Demo (Kat ve Kapı Bulma)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      crossorigin=""
    />
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      crossorigin=""
    ></script>
    <script src="dist/leaflet-simple-locate.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/low-pass-filter@1.0.0/dist/low-pass-filter.min.js"></script>

    <link rel="stylesheet" href="examples/demo.css" />
    <link rel="stylesheet" href="examples/style.css" />
    <link rel="stylesheet" href="examples/location-styles.css" />
    <link rel="stylesheet" href="examples/location-logger.css" />

    <style>
      .filter-panel {
        position: fixed;
        top: 10px;
        right: 10px;
        z-index: 1000;
        background: white;
        padding: 10px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        width: 220px;
        max-height: calc(100vh - 40px);
        overflow-y: auto;
        font-size: 13px;
      }

      .panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        padding-bottom: 5px;
        border-bottom: 1px solid #eee;
      }

      .panel-title {
        font-weight: bold;
        font-size: 14px;
        color: #333;
      }

      .toggle-button {
        background: none;
        border: none;
        padding: 0;
        cursor: pointer;
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background-color: #f5f5f5;
        color: #555;
        transition: all 0.2s;
      }

      .toggle-button:hover {
        background-color: #e0e0e0;
        color: #333;
      }

      .toggle-button i {
        font-size: 16px;
      }

      .filter-panel.collapsed {
        width: auto;
        height: auto;
        padding: 5px;
      }

      .filter-panel.collapsed .filter-content {
        display: none;
      }

      .filter-panel.collapsed .panel-title {
        display: none;
      }

      .filter-panel.collapsed .panel-header {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
      }

      .filter-group {
        margin-bottom: 8px;
      }

      .filter-group label {
        display: block;
        margin-bottom: 2px;
        font-weight: 500;
        color: #555;
        font-size: 12px;
      }

      .info-icon {
        margin-left: 3px;
        cursor: pointer;
        color: #2196f3;
        font-size: 14px;
        font-weight: bold;
      }

      .range-slider {
        width: 100%;
        margin: 3px 0;
        height: 8px;
      }

      .range-value {
        font-weight: bold;
        color: #2196f3;
        font-size: 11px;
      }

      .filter-actions {
        margin-top: 10px;
        display: flex;
        justify-content: space-between;
      }

      .filter-actions button {
        padding: 5px 10px;
        border: none;
        border-radius: 4px;
        background: #2196f3;
        color: white;
        cursor: pointer;
        transition: background 0.2s;
        font-size: 12px;
      }

      .filter-actions button:hover {
        background: #0b7dda;
      }

      .filter-actions button.reset {
        background: #f44336;
      }

      .filter-actions button.reset:hover {
        background: #d32f2f;
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1200;
        justify-content: center;
        align-items: center;
      }

      .modal-content {
        background: white;
        padding: 15px;
        border-radius: 8px;
        max-width: 70%;
        width: 300px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        text-align: center;
      }

      .modal-title {
        font-weight: bold;
        margin-bottom: 10px;
        color: #333;
        font-size: 16px;
      }

      .modal-description {
        margin-bottom: 15px;
        line-height: 1.4;
        color: #555;
        font-size: 14px;
      }

      .modal-button {
        padding: 8px 15px;
        background: #2196f3;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      .checkbox-group {
        display: flex;
        align-items: center;
        margin-bottom: 6px;
        font-size: 12px;
      }

      .checkbox-group input {
        margin-right: 6px;
      }

      .toggler {
        position: fixed;
        top: 10px;
        right: 10px;
        z-index: 999;
        background: white;
        padding: 6px;
        border-radius: 4px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        cursor: pointer;
        display: none;
        font-size: 13px;
      }

      /* Font Awesome benzeri ikonlar */
      @font-face {
        font-family: "Material Icons";
        font-style: normal;
        font-weight: 400;
        src: url(https://fonts.gstatic.com/s/materialicons/v140/flUhRq6tzZclQEJ-Vdg-IuiaDsNc.woff2)
          format("woff2");
      }

      .material-icons {
        font-family: "Material Icons";
        font-weight: normal;
        font-style: normal;
        font-size: 24px;
        line-height: 1;
        letter-spacing: normal;
        text-transform: none;
        display: inline-block;
        white-space: nowrap;
        word-wrap: normal;
        direction: ltr;
        -webkit-font-feature-settings: "liga";
        -webkit-font-smoothing: antialiased;
      }

      @media (max-width: 768px) {
        .filter-panel {
          width: 200px;
          font-size: 12px;
        }

        .modal-content {
          max-width: 85%;
          width: 280px;
        }
      }

      /* Status mesajı stili */
      .status-message {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1100;
        background: rgba(76, 175, 80, 0.9);
        color: white;
        padding: 8px 16px;
        border-radius: 50px;
        font-weight: bold;
        font-size: 14px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        text-align: center;
        animation: fadeInOut 3s forwards;
      }

      @keyframes fadeInOut {
        0% {
          opacity: 0;
        }
        10% {
          opacity: 1;
        }
        80% {
          opacity: 1;
        }
        100% {
          opacity: 0;
        }
      }
    </style>
  </head>

  <body>
    <div id="map"></div>

    <!-- Wei Ye Filtreleme Paneli -->
    <div id="filterPanel" class="filter-panel">
      <div class="panel-header">
        <div class="panel-title">Konum Filtreleme</div>
        <button id="togglePanel" class="toggle-button">
          <i class="material-icons">tune</i>
        </button>
      </div>

      <div class="filter-content">
        <div class="checkbox-group">
          <input type="checkbox" id="enableFiltering" checked />
          <label for="enableFiltering"
            >Filtreleme
            <span
              class="info-icon"
              data-title="Filtreleme"
              data-info="Bu seçenek tüm Wei Ye konum filtrelemesini açar/kapatır."
              >ℹ</span
            ></label
          >
        </div>

        <div class="checkbox-group">
          <input type="checkbox" id="enableLowPassFilter" checked />
          <label for="enableLowPassFilter"
            >Low Pass
            <span
              class="info-icon"
              data-title="Low Pass Filtre"
              data-info="Konum değişimlerini yumuşatan temel bir filtredir. Ani GPS sıçramalarını engeller."
              >ℹ</span
            ></label
          >
        </div>

        <div class="checkbox-group">
          <input type="checkbox" id="showJumpWarnings" checked />
          <label for="showJumpWarnings"
            >Uyarılar
            <span
              class="info-icon"
              data-title="Sıçrama Uyarıları"
              data-info="GPS konumunda ani ve büyük değişiklikler tespit edildiğinde ekranda uyarı gösterir."
              >ℹ</span
            ></label
          >
        </div>

        <div class="filter-group">
          <label for="medianWindowSize"
            >Medyan Pencere
            <span
              class="info-icon"
              data-title="Medyan Pencere Boyutu"
              data-info="Konum verilerinin son birkaç ölçümünden ortanca değeri kullanır. Büyük değerler daha çok yumuşatır ancak tepki süresini artırır ve gecikmeye sebep olabilir."
              >ℹ</span
            ></label
          >
          <input
            type="range"
            id="medianWindowSize"
            min="2"
            max="10"
            value="3"
            class="range-slider"
          />
          <span class="range-value">3</span>
        </div>

        <div class="filter-group">
          <label for="kalmanProcessNoise"
            >Kalman Q
            <span
              class="info-icon"
              data-title="Kalman İşlem Gürültüsü (Q)"
              data-info="Kalman filtresinin işlem gürültüsü parametresidir. Yüksek değerler GPS verilerine daha çok güvenmeyi, düşük değerler ise daha stabil ancak daha geç tepki veren sonuçları sağlar."
              >ℹ</span
            ></label
          >
          <input
            type="range"
            id="kalmanProcessNoise"
            min="0.001"
            max="0.2"
            value="0.05"
            step="0.001"
            class="range-slider"
          />
          <span class="range-value">0.05</span>
        </div>

        <div class="filter-group">
          <label for="kalmanMeasurementNoise"
            >Kalman R
            <span
              class="info-icon"
              data-title="Kalman Ölçüm Gürültüsü (R)"
              data-info="Kalman filtresinin ölçüm gürültüsü parametresidir. Yüksek değerler ölçümlere daha az güvenmeyi ve daha yumuşak ancak geciktirilmiş sonuçları sağlar. Kapalı alanlarda daha yüksek değerler kullanılması önerilir."
              >ℹ</span
            ></label
          >
          <input
            type="range"
            id="kalmanMeasurementNoise"
            min="0.01"
            max="1"
            value="0.2"
            step="0.01"
            class="range-slider"
          />
          <span class="range-value">0.2</span>
        </div>

        <div class="filter-group">
          <label for="jumpThreshold"
            >Sıçrama Eşiği
            <span
              class="info-icon"
              data-title="Sıçrama Tespit Eşiği"
              data-info="GPS sıçramasının tespit edilmesi için gerekli minimum konum değişimi eşiğidir. Yüksek değerler daha az sıçrama tespiti yapar, düşük değerler küçük sıçramaları bile tespit eder. Kapalı alanlarda daha düşük değerler kullanılması önerilir."
              >ℹ</span
            ></label
          >
          <input
            type="range"
            id="jumpThreshold"
            min="0.0001"
            max="0.001"
            value="0.0005"
            step="0.0001"
            class="range-slider"
          />
          <span class="range-value">0.0005</span>
        </div>

        <div class="filter-group">
          <label for="lowPassFilterTau"
            >Tau Değeri
            <span
              class="info-icon"
              data-title="Low Pass Filtre Tau Değeri"
              data-info="Low pass filtresinin zaman sabitidir. Yüksek tau değerleri (3.0) daha fazla yumuşatma yapar ve hareketli nesnelerde gecikmeye neden olabilir. Düşük tau değerleri (0.1-0.5) daha az yumuşatır ama daha hızlı tepki verir."
              >ℹ</span
            ></label
          >
          <input
            type="range"
            id="lowPassFilterTau"
            min="0.1"
            max="3"
            value="0.5"
            step="0.1"
            class="range-slider"
          />
          <span class="range-value">0.5</span>
        </div>

        <div class="filter-group">
          <label for="altitudeReference"
            >Altitude Referansı
            <span
              class="info-icon"
              data-title="Altitude Referans Sistemi"
              data-info="Yükseklik referans sistemi. 'Native': Her platform kendi sistemini kullanır (iOS: Deniz seviyesi ~40m, Android: GPS Ellipsoid ~73m). 'MSL': Tüm değerler deniz seviyesine çevrilir. 'WGS84': Tüm değerler GPS elipsoidine çevrilir. Formül: h = H + N"
              >ℹ</span
            ></label
          >
          <select id="altitudeReference" class="range-slider">
            <option value="native" selected>Native (Platform Varsayılan)</option>
            <option value="msl">MSL (Deniz Seviyesi)</option>
            <option value="wgs84">WGS84 (GPS Ellipsoid)</option>
          </select>
        </div>

        <div class="filter-actions">
          <button id="applyFilters">Uygula</button>
          <button id="resetFilters" class="reset">Sıfırla</button>
        </div>
      </div>
    </div>

    <!-- Modal Dialog -->
    <div id="infoModal" class="modal">
      <div class="modal-content">
        <div class="modal-title" id="modalTitle">Parametre Bilgisi</div>
        <div class="modal-description" id="modalDescription">
          Parametre hakkında detaylı açıklama burada görünecek.
        </div>
        <button class="modal-button" id="closeModal">Anladım</button>
      </div>
    </div>

    <script src="dist/location-app.js"></script>
    <script src="dist/location-logger.js"></script>

    <script>
      // Default parametreler - orijinal değerler
      const defaultFilters = {
        medianWindowSize: 3,
        kalmanProcessNoise: 0.05,
        kalmanMeasurementNoise: 0.2,
        jumpThreshold: 0.0005,
        lowPassFilterTau: 0.5,
        enableFiltering: true,
        enableLowPassFilter: true,
        showJumpWarnings: true,
        altitudeReference: 'native',
      };

      // Wei Ye filtreleme panel kontrolleri

      const filterPanel = document.getElementById("filterPanel");
      const togglePanel = document.getElementById("togglePanel");
      const applyFilters = document.getElementById("applyFilters");
      const resetFilters = document.getElementById("resetFilters");
      const infoModal = document.getElementById("infoModal");
      const modalTitle = document.getElementById("modalTitle");
      const modalDescription = document.getElementById("modalDescription");
      const closeModal = document.getElementById("closeModal");

      // Range slider ların değer göstergeleri
      document.querySelectorAll(".range-slider").forEach((slider) => {
        slider.addEventListener("input", function () {
          this.nextElementSibling.textContent = this.value;
        });
      });

      // Bilgi ikonu tıklama olayı
      document.querySelectorAll(".info-icon").forEach((icon) => {
        icon.addEventListener("click", function () {
          const title = this.getAttribute("data-title");
          const info = this.getAttribute("data-info");

          modalTitle.textContent = title;
          modalDescription.textContent = info;
          infoModal.style.display = "flex";
        });
      });

      // Modal kapatma
      closeModal.addEventListener("click", function () {
        infoModal.style.display = "none";
      });

      // Modal dışına tıklayınca da kapansın
      infoModal.addEventListener("click", function (e) {
        if (e.target === infoModal) {
          infoModal.style.display = "none";
        }
      });

      // Panel toggle fonksiyonu
      togglePanel.addEventListener("click", function () {
        filterPanel.classList.toggle("collapsed");
        this.querySelector("i").textContent = filterPanel.classList.contains(
          "collapsed"
        )
          ? "settings"
          : "tune";
      });

      // Filtreleri uygula
      applyFilters.addEventListener("click", function () {
        const settings = {
          medianWindowSize: parseInt(
            document.getElementById("medianWindowSize").value
          ),
          kalmanProcessNoise: parseFloat(
            document.getElementById("kalmanProcessNoise").value
          ),
          kalmanMeasurementNoise: parseFloat(
            document.getElementById("kalmanMeasurementNoise").value
          ),
          jumpThreshold: parseFloat(
            document.getElementById("jumpThreshold").value
          ),
          lowPassFilterTau: parseFloat(
            document.getElementById("lowPassFilterTau").value
          ),
          enableFiltering: document.getElementById("enableFiltering").checked,
          enableLowPassFilter: document.getElementById("enableLowPassFilter")
            .checked,
          showJumpWarnings: document.getElementById("showJumpWarnings").checked,
          altitudeReference: document.getElementById("altitudeReference").value,
        };

        // SimpleLocate nesnesinin seçeneklerini güncelle

        if (window.filterControl) {
          // Altitude referansı değişti mi kontrol et
          const oldAltRef = window.filterControl.options.altitudeReference;
          const newAltRef = settings.altitudeReference;
          
          // Tüm ayarları güncelle
          Object.keys(settings).forEach((key) => {
            window.filterControl.options[key] = settings[key];
          });

          // Altitude referansı değiştiyse ve konum varsa, marker'ı güncelle
          // Bu, afterDeviceMove callback'ini tetikler ve altitude yeniden hesaplanır
          if (oldAltRef !== newAltRef && window.filterControl._latitude && window.filterControl._altitude !== undefined) {
            console.log(`Altitude referansı değişti: ${oldAltRef} → ${newAltRef}, marker güncelleniyor...`);
            window.filterControl._updateMarker();
          }

          // Uygulama bilgisi
          showStatusMessage("Filtre ayarları uygulandı");
        } else {
          console.error("SimpleLocate kontrolü henüz yüklenmemiş!");
          showStatusMessage("Hata: Kontrol yüklenemedi!", true);
        }
      });

      // Filtreleri sıfırla
      resetFilters.addEventListener("click", function () {
        // Form elemanlarını varsayılan değerlere sıfırla
        document.getElementById("medianWindowSize").value =
          defaultFilters.medianWindowSize;
        document.getElementById("kalmanProcessNoise").value =
          defaultFilters.kalmanProcessNoise;
        document.getElementById("kalmanMeasurementNoise").value =
          defaultFilters.kalmanMeasurementNoise;
        document.getElementById("jumpThreshold").value =
          defaultFilters.jumpThreshold;
        document.getElementById("lowPassFilterTau").value =
          defaultFilters.lowPassFilterTau;
        document.getElementById("enableFiltering").checked =
          defaultFilters.enableFiltering;
        document.getElementById("enableLowPassFilter").checked =
          defaultFilters.enableLowPassFilter;
        document.getElementById("showJumpWarnings").checked =
          defaultFilters.showJumpWarnings;
        document.getElementById("altitudeReference").value =
          defaultFilters.altitudeReference;

        // Range değer göstergelerini güncelle
        document.querySelectorAll(".range-slider").forEach((slider) => {
          slider.nextElementSibling.textContent = slider.value;
        });

        // Varsayılan ayarları uygula

        if (window.filterControl) {
          Object.keys(defaultFilters).forEach((key) => {
            window.filterControl.options[key] = defaultFilters[key];
          });

          showStatusMessage("Varsayılan değerler yüklendi");
        } else {
          showStatusMessage("Hata: Kontrol yüklenemedi!", true);
        }
      });

      // Durum mesajı gösterme fonksiyonu
      function showStatusMessage(message, isError = false) {
        const notification = document.createElement("div");
        notification.className = "status-message";
        notification.textContent = message;
        notification.style.backgroundColor = isError
          ? "rgba(244,67,54,0.9)"
          : "rgba(76,175,80,0.9)";
        document.body.appendChild(notification);

        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 3000);
      }

      // DOMContentLoaded olayı en sonda tanımlanmalı
      document.addEventListener("DOMContentLoaded", function () {
        // Sayfa tamamen yüklendikten 500ms sonra kontrol değişkenini global scope'a taşı
        setTimeout(() => {
          try {
            // location-app.js'deki control değişkenini window nesnesine aktar
            window.filterControl = control;
            console.log(
              "SimpleLocate kontrolü window.filterControl'e aktarıldı ve hazır."
            );

            // İlk bulunan kontrolün parametrelerini al
            const currentSettings = {};
            Object.keys(defaultFilters).forEach((key) => {
              if (window.filterControl && window.filterControl.options) {
                currentSettings[key] = window.filterControl.options[key];
                // UI elemanlarını güncelleyelim
                if (
                  key === "medianWindowSize" ||
                  key === "kalmanProcessNoise" ||
                  key === "kalmanMeasurementNoise" ||
                  key === "jumpThreshold" ||
                  key === "lowPassFilterTau"
                ) {
                  const input = document.getElementById(key);
                  if (input) {
                    input.value = currentSettings[key];
                    input.nextElementSibling.textContent = currentSettings[key];
                  }
                } else if (
                  key === "enableFiltering" ||
                  key === "enableLowPassFilter" ||
                  key === "showJumpWarnings"
                ) {
                  const checkbox = document.getElementById(key);
                  if (checkbox) {
                    checkbox.checked = currentSettings[key];
                  }
                } else if (key === "altitudeReference") {
                  const select = document.getElementById(key);
                  if (select) {
                    select.value = currentSettings[key];
                  }
                }
              }
            });
          } catch (e) {
            console.error("SimpleLocate kontrolüne erişim sağlanamadı:", e);
          }
        }, 500);
      });
    </script>
  </body>
</html>
