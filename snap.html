<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="utf-8" />
    <title>Map Matching - Yol Takibi</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <!-- Turf.js for spatial calculations -->
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        #map {
            width: 100%;
            height: 100vh;
        }
        .controls {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.4);
            max-width: 250px;
        }
        .controls h3 {
            margin: 0 0 10px 0;
            font-size: 16px;
        }
        .controls button {
            width: 100%;
            margin-bottom: 8px;
            padding: 10px 12px;
            border: none;
            border-radius: 4px;
            background: #2196F3;
            color: white;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
        }
        .controls button:hover {
            background: #0b7dda;
        }
        
        /* Yollar için stiller */
        .path {
            stroke: #4CAF50;
            stroke-width: 5;
            stroke-opacity: 0.8;
        }
        
        /* Konumunuzun görsel stili */
        .matched-position {
            stroke: #2196F3;
            stroke-width: 2;
            stroke-opacity: 1;
            fill: #2196F3;
            fill-opacity: 0.7;
        }
        
        /* Kullanıcının izlediği hat için stil */
        .user-track {
            stroke: #9C27B0;
            stroke-width: 4;
            stroke-opacity: 0.7;
        }
        
        /* Durum bildirimi */
        .status {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: rgba(76,175,80,0.9);
            color: white;
            padding: 8px 16px;
            border-radius: 50px;
            font-weight: bold;
            font-size: 14px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            text-align: center;
        }
        
        .status.error {
            background: rgba(244,67,54,0.9);
        }
    </style>
</head>

<body>
    <div id="map"></div>
    
    <div class="controls">
        <h3>Yol Takibi</h3>
        <button id="startTracking">Konum Takibini Başlat</button>
        <button id="clearTrack">İzleri Temizle</button>
        <button id="centerMap">Konuma Git</button>
    </div>
    
    <script>
        // Başlangıç konumu (verdiğiniz koordinatlar)
        const initialCoords = [37.425947, 31.852208];
        
        // Leaflet haritasını oluştur
        const map = L.map('map', {
            center: initialCoords,
            zoom: 19,
            maxZoom: 22
        });
        
        // OpenStreetMap altlık haritasını ekle
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        
        // Verdiğiniz ana yol koordinatları
        const mainPath = [
            [37.425947, 31.852208],
            [37.425855, 31.852246]
        ];
        
        // Ana yolla birleşen iki ek yol
        // 1. Birinci yol - Ana yolun başlangıcından uzanan
        const path1 = [
            [37.425947, 31.852208],  // Ana yolun başlangıcı
            [37.426020, 31.852170],  // Kuzeybatı yönü
            [37.426080, 31.852140]   // Daha uzak nokta
        ];
        
        // 2. İkinci yol - Ana yolun sonundan uzanan
        const path2 = [
            [37.425855, 31.852246],  // Ana yolun sonu
            [37.425800, 31.852300],  // Güneydoğu yönü
            [37.425750, 31.852350]   // Daha uzak nokta
        ];
        
        // Tüm yolları bir dizide topla
        const allPaths = [
            { id: 'ana-yol', coords: mainPath },
            { id: 'yan-yol-1', coords: path1 },
            { id: 'yan-yol-2', coords: path2 }
        ];
        
        // Yolları haritaya ekle
        allPaths.forEach(path => {
            const line = L.polyline(path.coords, {
                className: 'path',
                id: path.id
            }).addTo(map);
            
            // Yol bilgisini objeye ekle
            path.line = line;
        });
        
        // Kullanıcının konumunu temsil eden değişkenler
        let userPositionMarker = null;
        let userTrack = null;
        let userTrackPositions = [];
        let watchId = null;
        let isTracking = false;
        
        // Maksimum snap mesafesi (metre cinsinden)
        const snapDistance = 30;
        
        // UI elemanları
        const startTrackingBtn = document.getElementById('startTracking');
        const clearTrackBtn = document.getElementById('clearTrack');
        const centerMapBtn = document.getElementById('centerMap');
        
        // Buton tıklama olaylarını izle
        startTrackingBtn.addEventListener('click', () => {
            if (isTracking) {
                stopTracking();
                startTrackingBtn.textContent = 'Konum Takibini Başlat';
                showStatus('Konum takibi durduruldu', false);
            } else {
                startTracking();
                startTrackingBtn.textContent = 'Konum Takibini Durdur';
            }
        });
        
        clearTrackBtn.addEventListener('click', () => {
            clearUserTrack();
            showStatus('İzler temizlendi', false);
        });
        
        centerMapBtn.addEventListener('click', () => {
            if (userPositionMarker) {
                map.setView(userPositionMarker.getLatLng(), 19);
                showStatus('Konuma gidildi', false);
            } else {
                showStatus('Konum bulunamadı!', true);
            }
        });
        
        // Konum takibi başlatma
        function startTracking() {
            if (!navigator.geolocation) {
                showStatus('Tarayıcınız konum hizmetini desteklemiyor!', true);
                return;
            }
            
            isTracking = true;
            showStatus('Konum alınıyor...', false);
            
            // Konum izlemeyi başlat
            watchId = navigator.geolocation.watchPosition(
                // Başarılı konum alımı
                (position) => {
                    const { latitude, longitude, accuracy } = position.coords;
                    
                    // Konumu map matching ile güncelle
                    updatePositionWithMatching(latitude, longitude);
                    
                    // Haritayı ilk konumda merkezle
                    if (!userPositionMarker) {
                        map.setView([latitude, longitude], 19);
                    }
                    
                    showStatus(`Konum alındı (±${Math.round(accuracy)}m)`, false);
                },
                // Konum hatası
                (error) => {
                    let errorMsg = 'Konum alınamadı';
                    
                    switch (error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg = 'Konum izni verilmedi';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg = 'Konum bilgisi kullanılamıyor';
                            break;
                        case error.TIMEOUT:
                            errorMsg = 'Konum alımı zaman aşımına uğradı';
                            break;
                    }
                    
                    showStatus(errorMsg, true);
                    stopTracking();
                    startTrackingBtn.textContent = 'Konum Takibini Başlat';
                },
                // Konum seçenekleri
                {
                    enableHighAccuracy: true,
                    maximumAge: 0,
                    timeout: 10000
                }
            );
        }
        
        // Konum takibi durdurma
        function stopTracking() {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
                isTracking = false;
            }
        }
        
        // Konumu Map Matching ile güncelleme
        function updatePositionWithMatching(lat, lng) {
            // Map matching uygula - en yakın yola snap'le
            const matchedResult = snapToNearestPath(lat, lng);
            
            // Eşleştirilmiş konum için marker oluştur/güncelle
            if (userPositionMarker) {
                userPositionMarker.setLatLng([matchedResult.snappedPosition.lat, matchedResult.snappedPosition.lng]);
            } else {
                userPositionMarker = L.circleMarker(
                    [matchedResult.snappedPosition.lat, matchedResult.snappedPosition.lng],
                    {
                        radius: 8,
                        className: 'matched-position'
                    }
                ).addTo(map);
            }
            
            // Kullanıcı izini güncelle (snap edilmiş konumu kullan)
            updateUserTrack(matchedResult.snappedPosition.lat, matchedResult.snappedPosition.lng);
        }
        
        // Konum verisini en yakın yola snap'leme fonksiyonu
        function snapToNearestPath(lat, lng) {
            let minDistance = Infinity;
            let nearestLine = null;
            let snappedPosition = null;
            
            // Tüm yolları kontrol et
            allPaths.forEach(path => {
                const pathCoords = path.coords;
                
                // Her yol parçasını kontrol et
                for (let i = 0; i < pathCoords.length - 1; i++) {
                    const start = L.latLng(pathCoords[i]);
                    const end = L.latLng(pathCoords[i + 1]);
                    
                    // Turf.js ile nokta-doğru parçası mesafesini hesapla
                    const point = turf.point([lng, lat]);
                    const line = turf.lineString([
                        [start.lng, start.lat],
                        [end.lng, end.lat]
                    ]);
                    
                    const nearestPoint = turf.nearestPointOnLine(line, point);
                    const distance = nearestPoint.properties.dist * 1000; // km'den m'ye çevir
                    
                    if (distance < minDistance) {
                        minDistance = distance;
                        nearestLine = path;
                        snappedPosition = { 
                            lat: nearestPoint.geometry.coordinates[1], 
                            lng: nearestPoint.geometry.coordinates[0] 
                        };
                    }
                }
            });
            
            // Snap mesafesi maksimum değeri aşıyorsa, yine de snap et
            // Sadece çok uzaksa (50m+) orijinal konumu kullan
            if (minDistance > 50) {
                snappedPosition = { lat, lng };
                console.log(`Çok uzak: ${minDistance.toFixed(2)}m`);
            }
            
            return {
                originalPosition: { lat, lng },
                nearestLine: nearestLine,
                distance: minDistance,
                snappedPosition: snappedPosition
            };
        }
        
        // Kullanıcı izini güncelleme
        function updateUserTrack(lat, lng) {
            userTrackPositions.push([lat, lng]);
            
            // Eski izi kaldır
            if (userTrack) {
                map.removeLayer(userTrack);
            }
            
            // Yeni izi çiz (en az 2 nokta gerekli)
            if (userTrackPositions.length > 1) {
                userTrack = L.polyline(userTrackPositions, {
                    className: 'user-track'
                }).addTo(map);
            }
        }
        
        // Kullanıcı izini temizleme
        function clearUserTrack() {
            userTrackPositions = [];
            if (userTrack) {
                map.removeLayer(userTrack);
                userTrack = null;
            }
        }
        
        // Durum mesajı gösterme
        function showStatus(message, isError) {
            // Mevcut durum mesajını kaldır
            const existingStatus = document.querySelector('.status');
            if (existingStatus) {
                existingStatus.remove();
            }
            
            // Yeni durum mesajı oluştur
            const statusDiv = document.createElement('div');
            statusDiv.className = isError ? 'status error' : 'status';
            statusDiv.textContent = message;
            document.body.appendChild(statusDiv);
            
            // 3 saniye sonra mesajı kaldır
            setTimeout(() => {
                if (statusDiv.parentNode) {
                    statusDiv.remove();
                }
            }, 3000);
        }
        
        // Harita üzerinde tıklama ile konum test edebilme
        map.on('click', (e) => {
            if (!isTracking) {
                // Takip modunda değilse, tıklanan noktayı test et
                updatePositionWithMatching(e.latlng.lat, e.latlng.lng);
                showStatus('Test konumu ayarlandı', false);
            }
        });
        
        // Sayfa yüklendiğinde haritayı hazırla
        window.addEventListener('load', () => {
            // Haritayı belirtilen koordinatlara merkezle
            map.setView(initialCoords, 19);
            
            // Başlangıç bilgilerini göster
            showStatus('Yollar yüklendi. Konum takibini başlatın veya haritaya tıklayın.', false);
        });
    </script>
</body>
</html>